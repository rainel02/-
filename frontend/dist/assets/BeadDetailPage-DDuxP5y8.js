import{d as Be,y as it,o as De,z as rt,c as v,l as O,j as ut,k as ct,F as X,a as t,t as h,w as H,m as V,A as Ee,r as te,e as W,n as $,p as dt,v as vt,B as ae,b as ue,f as m,g as E,h as pt,i as c,q as ce,s as mt,_ as Ae,C as ft,D as gt,x as Ct}from"./index-BdZg5HdZ.js";import{b as Y}from"./beads-B4Vxsoum.js";const ht={class:"workbench"},yt={key:0,class:"card"},bt={class:"card section-card"},Ft={class:"row-between section-head"},wt={class:"row workbench-actions"},xt=["disabled"],Et={class:"row add-color-row"},Bt={class:"table-wrap",style:{"max-height":"260px"}},Dt={class:"table"},At=["onUpdate:modelValue"],kt=["onUpdate:modelValue"],Mt=["onClick"],$t={key:0,class:"debug-panel"},Rt={style:{"font-size":"12px",color:"#111827","margin-bottom":"6px"}},_t={open:""},It={class:"card section-card"},St={class:"row grid-settings-row"},Ht=["disabled"],Tt=["src"],Lt={class:"row selection-row"},Ut={class:"row nudge-toolbar"},Gt={class:"hint-text selection-coords"},jt={class:"nudge-panel"},zt={class:"nudge-grid"},Vt={class:"hint-text status-text"},Pt={class:"row-between section-head"},Xt={class:"hint-text"},Wt={class:"palette-wrap"},Yt=["onClick"],Nt=16,qt=64,B=8,Ot=Be({__name:"BeadWorkbench",props:{project:{}},setup(Z){const K=Z,F=m(20),r=m(20),D=m([]),P=m(""),T=m(1),R=m([]),L=m(null),y=m(!1),C=m(!1),se=m(!1),_=m(null),le=m("尚未分析"),M=m(30),j=m(null),U=m(null),ie=m(null),ne=m(null),re=m(null),G=m(null),I=m("BR"),N=m(1),n=ce({x:0,y:0,w:0,h:0}),J=m(!1),oe=ce({x:0,y:0});let d=null;const s=m(!1),f=m(!1),k=ce({x:0,y:0,scrollLeft:0,scrollTop:0}),ke={A1:"#FAF5CD",A2:"#FCFED6",A3:"#FCFF92",A4:"#F7EC5C",A5:"#FFE44B",A6:"#FDA951",A7:"#FA8C4F",A8:"#F9E045",A9:"#F99C5F",A10:"#F47E36",A11:"#FEDB99",A12:"#FDA276",A13:"#FEC667",A14:"#F85842",A15:"#FBF65E",A16:"#FEFF97",A17:"#FDE173",A18:"#FCBF80",A19:"#FD7E77",A20:"#F9D66E",A21:"#FAE393",A22:"#EDF878",A23:"#E1C9BD",A24:"#F3F6A9",A25:"#FFD785",A26:"#FEC832",B1:"#DFF139",B2:"#64F343",B3:"#9FF685",B4:"#5FDF34",B5:"#39E158",B6:"#64B0A4",B7:"#3FAE7C",B8:"#1D9E54",B9:"#2A5037",B10:"#9AD1BA",B11:"#627032",B12:"#1A6E3D",B13:"#C8E87D",B14:"#ACE84C",B15:"#305335",B16:"#C0ED9C",B17:"#9FB33E",B18:"#E6ED4F",B19:"#26B78E",B20:"#CAEDCF",B21:"#176268",B22:"#0A4241",B23:"#343B1A",B24:"#E8FAA6",B25:"#4E846D",B26:"#907C35",B27:"#D0E0AF",B28:"#9EE5BB",B29:"#C6DF5F",B30:"#E3FBB1",B31:"#B2F694",B32:"#92AD60",C1:"#FFFEE4",C2:"#ABF8FE",C3:"#9EE0F8",C4:"#44CDFB",C5:"#06ABE3",C6:"#54A7E9",C7:"#3977CC",C8:"#0F52BD",C9:"#3349C3",C10:"#3DBBE3",C11:"#2ADED3",C12:"#1E334E",C13:"#CDE7FE",C14:"#D6FDFC",C15:"#21C5C4",C16:"#1858A2",C17:"#02D1F3",C18:"#213244",C19:"#188690",C20:"#1A70A9",C21:"#BEDDFC",C22:"#6BB1BB",C23:"#C8E2F9",C24:"#7EC5F9",C25:"#A9E8E0",C26:"#42ADD1",C27:"#D0DEEF",C28:"#BDCEED",C29:"#364A89",D1:"#ACB7EF",D2:"#868DD3",D3:"#3653AF",D4:"#162C7E",D5:"#B34EC6",D6:"#B37BDC",D7:"#8758A9",D8:"#E3D2FE",D9:"#D6BAF5",D10:"#301A49",D11:"#BCBAE2",D12:"#DC99CE",D13:"#B5038F",D14:"#882893",D15:"#2F1E8E",D16:"#E2E4F0",D17:"#C7D3F9",D18:"#9A64B8",D19:"#D8C2D9",D20:"#9C34AD",D21:"#940595",D22:"#383995",D23:"#FADBF8",D24:"#768AE1",D25:"#4950C2",D26:"#D6C6EB",E1:"#F6D4CB",E2:"#FCC1DD",E3:"#F6BDE8",E4:"#E9639E",E5:"#F1559F",E6:"#BC4072",E7:"#C63674",E8:"#FDDBE9",E9:"#E575C7",E10:"#D33997",E11:"#F7DAD4",E12:"#F893BF",E13:"#B5026A",E14:"#FAD4BF",E15:"#F5C9CA",E16:"#FBF4EC",E17:"#F7E3EC",E18:"#FBCBDB",E19:"#F6BBD1",E20:"#D7C6CE",E21:"#C09DA4",E22:"#B58B9F",E23:"#937D8A",E24:"#DEBEE5",F1:"#FF9280",F2:"#F73D48",F3:"#EF4D3E",F4:"#F92B40",F5:"#E30328",F6:"#913635",F7:"#911932",F8:"#BB0126",F9:"#B0677A",F10:"#874628",F11:"#6F321D",F12:"#F8516D",F13:"#F45C45",F14:"#FCADB2",F15:"#D50527",F16:"#F8C0A9",F17:"#E89B7D",F18:"#D07E4A",F19:"#BE454A",F20:"#C69495",F21:"#F2BBC6",F22:"#F7C3D0",F23:"#EC806D",F24:"#E09DAF",F25:"#E84854",G1:"#FFEAD3",G2:"#FCC6AC",G3:"#F1C4A5",G4:"#DCB387",G5:"#E7B34E",G6:"#F3A014",G7:"#98503A",G8:"#4B2B1C",G9:"#E4B685",G10:"#DA8C42",G11:"#DAC898",G12:"#FEC993",G13:"#B2714B",G14:"#8B684C",G15:"#F6F8E3",G16:"#F2D8C1",G17:"#79544E",G18:"#FFEAD6",G19:"#DD7D41",G20:"#A5452F",G21:"#B38561",H1:"#FBFBFB",H2:"#FFFFFF",H3:"#B4B4B4",H4:"#878787",H5:"#464648",H6:"#2C2C2C",H7:"#010101",H8:"#E7D6DC",H9:"#EFEDEE",H10:"#ECEAEB",H11:"#CDCDCD",H12:"#FDF6EE",H13:"#F4EFD1",H14:"#CED7D4",H15:"#98A6A6",H16:"#1B1213",H17:"#F0EEEF",H18:"#FCFFF8",H19:"#F2EEE5",H20:"#96A09F",H21:"#F8FBE6",H22:"#CACADA",H23:"#9B9C94",M1:"#BBC6B6",M2:"#909994",M3:"#697E30",M4:"#E0D4BC",M5:"#D0CBAE",M6:"#B0AA86",M7:"#B0A796",M8:"#AE8082",M9:"#A88764",M10:"#C6B2BB",M11:"#9D7693",M12:"#644B51",M13:"#C79266",M14:"#C37463",M15:"#747D7A"};function me(l){return l.toUpperCase().trim().replace(/^([A-Z]+)0+(?=[1-9])/,"$1")}function Me(l){const e=me(l||"");return ke[e]||""}function $e(l){const e=(l||"").replace("#","");if(!/^[0-9a-fA-F]{6}$/.test(e))return"#111827";const a=Number.parseInt(e.slice(0,2),16),o=Number.parseInt(e.slice(2,4),16),i=Number.parseInt(e.slice(4,6),16);return(a*299+o*587+i*114)/1e3>125?"#111827":"#ffffff"}function fe(){const l=me(P.value||""),e=Number(T.value);if(!l){alert("请输入色号");return}if(!Number.isFinite(e)||e<=0){alert("数量必须大于 0");return}const a=D.value.find(o=>me(o.code||"")===l);a?(a.code=l,a.quantity=Number(a.quantity||0)+e):D.value.push({code:l,quantity:e}),P.value="",T.value=1}it(()=>K.project,async l=>{D.value=(l.requiredColors||[]).map(e=>({...e})),F.value=l.gridRows&&l.gridRows>0?l.gridRows:F.value,r.value=l.gridCols&&l.gridCols>0?l.gridCols:r.value,R.value=Ze(l.gridCellsJson,F.value*r.value),await mt(),ge()},{immediate:!0});const Re=E(()=>({display:"grid",gridTemplateColumns:`repeat(${r.value}, ${M.value}px)`,gap:"0",background:"#d1d5db"})),q=E(()=>M.value),_e=E(()=>Array.from({length:F.value},(l,e)=>e+1)),Ie=E(()=>Array.from({length:r.value},(l,e)=>e+1)),Se=E(()=>({display:"grid",gridTemplateColumns:`${q.value}px auto`,gridTemplateRows:`${q.value}px auto`,width:"max-content",minWidth:"100%"})),He=E(()=>({gridColumn:"2",gridRow:"1",display:"grid",gridTemplateColumns:`repeat(${r.value}, ${M.value}px)`,width:`${r.value*M.value}px`})),Te=E(()=>({gridColumn:"1",gridRow:"2",display:"grid",gridTemplateRows:`repeat(${F.value}, ${M.value}px)`,height:`${F.value*M.value}px`})),Ce=E(()=>({width:`${q.value}px`,height:`${q.value}px`,fontSize:`${Math.max(10,Math.floor(q.value*.32))}px`})),Le=E(()=>({width:`${q.value}px`,height:`${q.value}px`,fontSize:`${Math.max(10,Math.floor(q.value*.32))}px`}));function Ue(l,e){const a=L.value===null,o=l===L.value,i=l?Me(l):"",u=i?$e(i):"#111827",g=Math.floor(e/r.value),b=e%r.value,A=g%5===0,x=b%5===0,w=g===F.value-1,p=b===r.value-1;return{width:`${M.value}px`,height:`${M.value}px`,background:i||"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:`${Math.max(9,Math.floor(M.value*.32))}px`,color:u,opacity:a||!l||o?"1":"0.12",borderTop:A?"2px solid #9ca3af":"1px solid #e5e7eb",borderLeft:x?"2px solid #9ca3af":"1px solid #e5e7eb",borderRight:p?"2px solid #9ca3af":"1px solid #e5e7eb",borderBottom:w?"2px solid #9ca3af":"1px solid #e5e7eb",boxSizing:"border-box",transform:o?"scale(1.04)":"scale(1)",zIndex:o?1:0}}async function Ge(){if(K.project.patternImage){if(F.value<=0||r.value<=0){alert("行列数必须大于 0");return}if(!z.value){alert("请先框选图案主体区域");return}y.value=!0,le.value="正在调用百度 OCR 分析网格...";try{const l=Fe(),e=D.value.map(u=>(u.code||"").trim().toUpperCase()).filter(Boolean),a=await Y.analyzeGrid({imageBase64:l.dataUrl,rows:F.value,cols:r.value,imageWidth:l.width,imageHeight:l.height,candidateCodes:e}),o=F.value*r.value,i=new Array(o).fill("");for(const u of a.cells||[])u.row<0||u.row>=F.value||u.col<0||u.col>=r.value||(i[u.row*r.value+u.col]=u.code||"");R.value=i,await Y.saveGridResult(K.project.id,{rows:F.value,cols:r.value,cells:i}),le.value=`分析完成：OCR标记 ${a.ocrCount}，填充格子 ${a.filledCount}/${o}`}catch(l){console.error(l),le.value="分析失败，请调整选区后重试",alert("网格分析失败，请重试")}finally{y.value=!1}}}async function je(){if(!K.project.patternImage){alert("暂无图纸，请先上传图纸");return}if(!z.value){alert("请先框选色号区域");return}C.value=!0;try{const l=Fe();if(se.value){const e=await Y.extractColorsDebug(l.dataUrl);_.value=e,D.value=e.colors||[]}else{const e=await Y.extractColors(l.dataUrl);_.value=null,D.value=e}D.value.length===0&&alert("未识别到有效色号，请调整选区后重试")}catch(l){console.error(l),alert("识别失败，请稍后重试")}finally{C.value=!1}}async function ze(){const l=D.value.filter(e=>e.code&&e.quantity>0);await Y.saveColors(K.project.id,l),alert("保存成功")}function Q(){if(!j.value||!U.value)return null;const l=j.value.getBoundingClientRect(),e=U.value.getBoundingClientRect(),a=U.value.naturalWidth,o=U.value.naturalHeight;if(!a||!o)return{left:e.left-l.left,top:e.top-l.top,width:e.width,height:e.height};const i=e.width,u=e.height,g=a/o,b=i/u;let A=i,x=u,w=0,p=0;return g>b?(x=i/g,p=(u-x)/2):(A=u*g,w=(i-A)/2),{left:e.left-l.left+w,top:e.top-l.top+p,width:A,height:x}}function ge(){const l=Q();if(!l)return;const e=l.width*.1,a=l.height*.1;n.x=l.left+e,n.y=l.top+a,n.w=Math.max(B,l.width-e*2),n.h=Math.max(B,l.height-a*2),G.value=null}function Ve(){ge()}function Pe(){ge()}function de(l,e){e.preventDefault(),e.stopPropagation(),G.value=l,I.value=l,J.value=!0}function Xe(l){if(!G.value)return;const e=We(l),a=Q();if(!e||!a)return;be(e),ye(e);const o=n.x+n.w,i=n.y+n.h;if(G.value==="TL"){const x=Math.min(Math.max(e.x,a.left),o-B),w=Math.min(Math.max(e.y,a.top),i-B);n.w=o-x,n.h=i-w,n.x=x,n.y=w;return}if(G.value==="TR"){const x=a.left+a.width,w=Math.max(Math.min(e.x,x),n.x+B),p=Math.min(Math.max(e.y,a.top),i-B);n.w=w-n.x,n.h=i-p,n.y=p;return}if(G.value==="BL"){const x=a.top+a.height,w=Math.min(Math.max(e.x,a.left),o-B),p=Math.max(Math.min(e.y,x),n.y+B);n.w=o-w,n.h=p-n.y,n.x=w;return}const u=a.left+a.width,g=a.top+a.height,b=Math.max(Math.min(e.x,u),n.x+B),A=Math.max(Math.min(e.y,g),n.y+B);n.w=b-n.x,n.h=A-n.y}function he(){G.value=null,J.value=!1}function ye(l){if(!j.value)return;const e=150,a=12,o=j.value.clientWidth,i=j.value.clientHeight,u=G.value??I.value;let g=l.x+a,b=l.y+a;(u==="BR"||u==="BL")&&(b=l.y-e-a),g+e>o&&(g=o-e),b+e>i&&(b=i-e),g<0&&(g=0),b<0&&(b=0),oe.x=g,oe.y=b}function ve(){if(!Q())return;const e=I.value==="TL"?{x:n.x,y:n.y}:I.value==="TR"?{x:n.x+n.w,y:n.y}:I.value==="BL"?{x:n.x,y:n.y+n.h}:{x:n.x+n.w,y:n.y+n.h};J.value=!0,be(e),ye(e),d!==null&&window.clearTimeout(d),d=window.setTimeout(()=>{G.value||(J.value=!1)},900)}function pe(l,e){const a=Q();if(!a)return;const o=Number.isFinite(l)?l:0,i=Number.isFinite(e)?e:0;if(!o&&!i)return;const u=n.x+n.w,g=n.y+n.h,b=a.left+a.width,A=a.top+a.height;if(I.value==="TL"){const p=Math.min(Math.max(n.x+o,a.left),u-B),S=Math.min(Math.max(n.y+i,a.top),g-B);n.w=u-p,n.h=g-S,n.x=p,n.y=S,ve();return}if(I.value==="TR"){const p=Math.max(Math.min(u+o,b),n.x+B),S=Math.min(Math.max(n.y+i,a.top),g-B);n.w=p-n.x,n.h=g-S,n.y=S,ve();return}if(I.value==="BL"){const p=Math.min(Math.max(n.x+o,a.left),u-B),S=Math.max(Math.min(g+i,A),n.y+B);n.w=u-p,n.h=S-n.y,n.x=p,ve();return}const x=Math.max(Math.min(u+o,b),n.x+B),w=Math.max(Math.min(g+i,A),n.y+B);n.w=x-n.x,n.h=w-n.y,ve()}function be(l){if(!U.value||!ie.value)return;const e=Q();if(!e)return;const a=U.value,i=ie.value.getContext("2d");if(!i)return;const u=a.naturalWidth/e.width,g=a.naturalHeight/e.height,b=l.x-e.left,A=l.y-e.top,x=b*u,w=A*g,p=150,ee=p/4,at=x-ee/2,st=w-ee/2;i.clearRect(0,0,p,p),i.fillStyle="#fff",i.fillRect(0,0,p,p),i.drawImage(a,at,st,ee,ee,0,0,p,p),i.strokeStyle="rgba(255, 0, 0, 0.85)",i.lineWidth=1,i.beginPath(),i.moveTo(p/2,0),i.lineTo(p/2,p),i.moveTo(0,p/2),i.lineTo(p,p/2),i.stroke()}function We(l){const e=Q();if(!j.value||!e)return null;const a=j.value.getBoundingClientRect(),o=e.left+e.width,i=e.top+e.height,u=Math.max(e.left,Math.min(l.clientX-a.left,o)),g=Math.max(e.top,Math.min(l.clientY-a.top,i));return{x:u,y:g}}function Fe(){if(!U.value||!z.value)throw new Error("未选择裁剪区域");const l=Q();if(!l)throw new Error("图像位置无效");const e=U.value,a=l.width,o=l.height;if(!a||!o)throw new Error("图像尺寸无效");const i=e.naturalWidth/a,u=e.naturalHeight/o,g=n.x-l.left,b=n.y-l.top,A=Math.max(0,Math.floor(g*i)),x=Math.max(0,Math.floor(b*u)),w=Math.max(1,Math.floor(n.w*i)),p=Math.max(1,Math.floor(n.h*u)),S=document.createElement("canvas");S.width=w,S.height=p;const ee=S.getContext("2d");if(!ee)throw new Error("无法创建图像上下文");return ee.drawImage(e,A,x,w,p,0,0,w,p),{dataUrl:S.toDataURL("image/jpeg",.95),width:w,height:p}}function Ye(l){const e=M.value,a=l.deltaY<0?2:-2,o=Math.max(Nt,Math.min(qt,e+a));if(o===e)return;const i=ne.value;if(!i){M.value=o;return}const u=i.getBoundingClientRect(),g=l.clientX-u.left+i.scrollLeft,b=l.clientY-u.top+i.scrollTop,A=o/e;M.value=o,i.scrollLeft=g*A-(l.clientX-u.left),i.scrollTop=b*A-(l.clientY-u.top)}function Ne(l){if(l.button!==0)return;const e=ne.value;e&&(s.value=!0,k.x=l.clientX,k.y=l.clientY,k.scrollLeft=e.scrollLeft,k.scrollTop=e.scrollTop)}function qe(l){if(!s.value)return;const e=ne.value;if(!e)return;const a=l.clientX-k.x,o=l.clientY-k.y;e.scrollLeft=k.scrollLeft-a,e.scrollTop=k.scrollTop-o}function we(){s.value=!1}async function Oe(){const l=re.value;if(l)try{if(document.fullscreenElement===l){await document.exitFullscreen();return}if(!document.fullscreenElement){await l.requestFullscreen();return}await l.requestFullscreen()}catch(e){console.error(e),alert("当前浏览器不支持该全屏操作")}}function xe(){f.value=document.fullscreenElement===re.value}function Ze(l,e){if(!l)return new Array(e).fill("");try{const a=JSON.parse(l);if(!Array.isArray(a))return new Array(e).fill("");const o=a.map(i=>i==null?"":String(i));return o.length<e?[...o,...new Array(e-o.length).fill("")]:o.slice(0,e)}catch{return new Array(e).fill("")}}const z=E(()=>n.w>0&&n.h>0),Ke=E(()=>{const l=R.value.filter(Boolean),e=D.value.map(a=>(a.code||"").trim().toUpperCase()).filter(Boolean);return Array.from(new Set([...l,...e])).sort((a,o)=>a.localeCompare(o,"en"))}),Je=E(()=>({left:`${n.x}px`,top:`${n.y}px`,width:`${n.w}px`,height:`${n.h}px`})),Qe=E(()=>({left:`${n.x}px`,top:`${n.y}px`})),et=E(()=>({left:`${n.x+n.w}px`,top:`${n.y}px`})),tt=E(()=>({left:`${n.x}px`,top:`${n.y+n.h}px`})),lt=E(()=>({left:`${n.x+n.w}px`,top:`${n.y+n.h}px`})),nt=E(()=>{if(!z.value)return"未框选";const l=Math.round(n.x),e=Math.round(n.y),a=Math.round(n.x+n.w),o=Math.round(n.y+n.h);return`左上(${l}, ${e}) 右上(${a}, ${e}) 左下(${l}, ${o}) 右下(${a}, ${o})`}),ot=E(()=>({left:`${oe.x}px`,top:`${oe.y}px`}));return De(()=>{document.addEventListener("fullscreenchange",xe)}),rt(()=>{document.removeEventListener("fullscreenchange",xe)}),(l,e)=>{const a=pt("RouterLink");return c(),v("div",ht,[Z.project.patternImage?(c(),v(X,{key:1},[t("div",bt,[t("div",Ft,[e[18]||(e[18]=t("h4",{class:"section-subtitle"},"需要色号与数量",-1)),t("div",wt,[t("button",{class:"btn secondary",disabled:C.value||!Z.project.patternImage||!z.value,onClick:je},h(C.value?"识别中...":"识别"),9,xt),t("button",{class:"btn success",onClick:ze},"保存")])]),e[25]||(e[25]=t("p",{class:"hint-text"},"先在下方图纸中框选“色号+数量”区域，再点击“识别”。",-1)),t("div",Et,[H(t("input",{class:"input manual-code-input","onUpdate:modelValue":e[0]||(e[0]=o=>P.value=o),placeholder:"手动新增色号（如 A1）",onKeyup:Ee(fe,["enter"])},null,544),[[V,P.value]]),H(t("input",{class:"input manual-qty-input",type:"number",min:"1","onUpdate:modelValue":e[1]||(e[1]=o=>T.value=o),onKeyup:Ee(fe,["enter"])},null,544),[[V,T.value,void 0,{number:!0}]]),t("button",{class:"btn secondary",onClick:fe},"添加色号")]),t("div",Bt,[t("table",Dt,[e[19]||(e[19]=t("thead",null,[t("tr",null,[t("th",null,"色号"),t("th",null,"数量"),t("th")])],-1)),t("tbody",null,[(c(!0),v(X,null,te(D.value,(o,i)=>(c(),v("tr",{key:i},[t("td",null,[H(t("input",{class:"input","onUpdate:modelValue":u=>o.code=u},null,8,At),[[V,o.code]])]),t("td",null,[H(t("input",{class:"input",type:"number",min:"1","onUpdate:modelValue":u=>o.quantity=u},null,8,kt),[[V,o.quantity,void 0,{number:!0}]])]),t("td",null,[t("button",{class:"btn warn",onClick:u=>D.value.splice(i,1)},"删",8,Mt)])]))),128))])])]),se.value&&_.value?(c(),v("div",$t,[t("div",Rt,[e[20]||(e[20]=t("strong",null,"调试策略：",-1)),O(h(_.value.strategy||"unknown"),1)]),t("details",_t,[e[21]||(e[21]=t("summary",null,"坐标分行结果",-1)),t("pre",null,h((_.value.locationLines||[]).join(`
`)||"（空）"),1)]),t("details",null,[e[22]||(e[22]=t("summary",null,"双行/兜底配对日志",-1)),t("pre",null,h((_.value.pairLogs||[]).join(`
`)||"（空）"),1)]),t("details",null,[e[23]||(e[23]=t("summary",null,"文本兜底日志",-1)),t("pre",null,h((_.value.fallbackLogs||[]).join(`
`)||"（空）"),1)]),t("details",null,[e[24]||(e[24]=t("summary",null,"OCR 原始文本",-1)),t("pre",null,h(_.value.rawText||"（空）"),1)])])):W("",!0)]),t("div",It,[e[31]||(e[31]=t("h4",{class:"section-subtitle"},"网格设置与分析",-1)),t("div",St,[e[26]||(e[26]=t("label",null,"行数",-1)),H(t("input",{class:"input compact-control",type:"number","onUpdate:modelValue":e[2]||(e[2]=o=>F.value=o)},null,512),[[V,F.value,void 0,{number:!0}]]),e[27]||(e[27]=t("label",null,"列数",-1)),H(t("input",{class:"input compact-control",type:"number","onUpdate:modelValue":e[3]||(e[3]=o=>r.value=o)},null,512),[[V,r.value,void 0,{number:!0}]]),t("button",{class:"btn secondary",onClick:Ge,disabled:y.value||!Z.project.patternImage},h(y.value?"分析中...":"分析网格"),9,Ht)]),e[32]||(e[32]=t("p",{class:"hint-text"},"先拖动四个角控制点框选图案主体，再点击“分析网格”。",-1)),t("div",{ref_key:"cropStageRef",ref:j,class:"crop-stage",onMousemove:Xe,onMouseup:he,onMouseleave:he},[t("img",{ref_key:"patternImgRef",ref:U,src:Z.project.patternImage,class:"crop-image",onLoad:Pe},null,40,Tt),z.value?(c(),v("div",{key:0,class:"crop-mask",style:$(Je.value)},null,4)):W("",!0),z.value?(c(),v("div",{key:1,class:"crop-handle",style:$(Qe.value),onMousedown:e[4]||(e[4]=o=>de("TL",o))},null,36)):W("",!0),z.value?(c(),v("div",{key:2,class:"crop-handle",style:$(et.value),onMousedown:e[5]||(e[5]=o=>de("TR",o))},null,36)):W("",!0),z.value?(c(),v("div",{key:3,class:"crop-handle",style:$(tt.value),onMousedown:e[6]||(e[6]=o=>de("BL",o))},null,36)):W("",!0),z.value?(c(),v("div",{key:4,class:"crop-handle",style:$(lt.value),onMousedown:e[7]||(e[7]=o=>de("BR",o))},null,36)):W("",!0),H(t("div",{class:"magnifier",style:$(ot.value)},[t("canvas",{ref_key:"magnifierCanvasRef",ref:ie,width:"150",height:"150"},null,512)],4),[[dt,J.value]])],544),t("div",Lt,[t("div",Ut,[e[29]||(e[29]=t("label",{class:"hint-text"},"微调角点",-1)),H(t("select",{class:"select compact-control","onUpdate:modelValue":e[8]||(e[8]=o=>I.value=o)},[...e[28]||(e[28]=[t("option",{value:"TL"},"左上角",-1),t("option",{value:"TR"},"右上角",-1),t("option",{value:"BL"},"左下角",-1),t("option",{value:"BR"},"右下角",-1)])],512),[[vt,I.value]]),e[30]||(e[30]=t("label",{class:"hint-text"},"步长",-1)),H(t("input",{class:"input compact-step",type:"number",min:"1",max:"20","onUpdate:modelValue":e[9]||(e[9]=o=>N.value=o)},null,512),[[V,N.value,void 0,{number:!0}]])]),t("div",Gt,h(nt.value),1),t("button",{class:"btn secondary compact-btn selection-reset",onClick:Ve},"重置选区")]),t("div",jt,[t("div",zt,[t("button",{class:"btn secondary",onClick:e[10]||(e[10]=o=>pe(0,-N.value))},"↑"),t("button",{class:"btn secondary",onClick:e[11]||(e[11]=o=>pe(-N.value,0))},"←"),t("button",{class:"btn secondary",onClick:e[12]||(e[12]=o=>pe(N.value,0))},"→"),t("button",{class:"btn secondary",onClick:e[13]||(e[13]=o=>pe(0,N.value))},"↓")])]),t("div",Vt,h(le.value),1)]),t("div",{ref_key:"fullscreenHostRef",ref:re,class:ae(["card fullscreen-host",{"is-fullscreen":f.value}])},[t("div",Pt,[e[33]||(e[33]=t("h4",{class:"section-subtitle"},"开始拼豆",-1)),t("button",{class:"btn secondary",onClick:Oe},h(f.value?"退出全屏":"全屏查看图纸"),1)]),t("div",Xt," 图纸网格："+h(F.value)+" 行 × "+h(r.value)+" 列（每 5 行/列加深边框） ",1),t("div",Wt,[t("button",{class:ae(["palette-btn",{active:L.value===null}]),onClick:e[14]||(e[14]=o=>L.value=null)},"全部显示",2),(c(!0),v(X,null,te(Ke.value,o=>(c(),v("button",{key:o,class:ae(["palette-btn",{active:L.value===o}]),onClick:i=>L.value=o},h(o),11,Yt))),128))]),t("div",{ref_key:"gridViewportRef",ref:ne,class:ae(["bead-grid-scroll",{panning:s.value}]),onWheel:ue(Ye,["prevent"]),onMousedown:Ne,onMousemove:qe,onMouseup:we,onMouseleave:we},[t("div",{class:"indexed-grid",style:$(Se.value)},[t("div",{class:"grid-corner",style:$(Le.value)},"#",4),t("div",{class:"grid-col-header",style:$(He.value)},[(c(!0),v(X,null,te(Ie.value,o=>(c(),v("div",{key:`col-${o}`,class:"grid-index-cell",style:$(Ce.value)},h(o),5))),128))],4),t("div",{class:"grid-row-header",style:$(Te.value)},[(c(!0),v(X,null,te(_e.value,o=>(c(),v("div",{key:`row-${o}`,class:"grid-index-cell",style:$(Ce.value)},h(o),5))),128))],4),t("div",{class:"bead-grid-inner",style:$(Re.value)},[(c(!0),v(X,null,te(R.value,(o,i)=>(c(),v("div",{key:i,style:$(Ue(o,i))},h(o||""),5))),128))],4)],4)],34)],2)],64)):(c(),v("div",yt,[e[16]||(e[16]=O("暂无图纸，请先",-1)),ut(a,{to:`/detail/${Z.project.id}`},{default:ct(()=>[...e[15]||(e[15]=[O("上传图纸",-1)])]),_:1},8,["to"]),e[17]||(e[17]=O("再开始拼豆",-1))]))])}}}),Zt=Ae(Ot,[["__scopeId","data-v-79cce5e7"]]),Kt={key:0,class:"card detail-page"},Jt={class:"row-between detail-toolbar"},Qt={class:"section-title"},el=["href"],tl={key:1},ll={class:"row-between tabs-header"},nl={class:"page-tabs",role:"tablist","aria-label":"详情分页"},ol={key:0,class:"detail-overview"},al={class:"overview-state-bar"},sl={class:"overview-inline-grid"},il={class:"field-value"},rl={class:"row detail-tag-list inline-tag-list"},ul={key:0,class:"field-value"},cl={class:"detail-image-block"},dl=["src"],vl={key:1},pl={class:"detail-image-block"},ml=["src"],fl={key:1},gl={key:1,class:"card"},Cl={class:"overview-edit"},hl={class:"edit-label"},yl={class:"row detail-tag-list"},bl={class:"tag-item-label"},Fl=["value"],wl=["onClick"],xl={class:"row add-tag-row"},El={class:"edit-label top-gap"},Bl={class:"detail-image-block"},Dl={class:"row file-action-row"},Al=["src"],kl={key:1},Ml={class:"detail-image-block"},$l={class:"row file-action-row"},Rl=["src"],_l={key:1},Il={class:"row edit-modal-actions"},Sl=["disabled"],Hl=["disabled"],Tl={class:"confirm-text"},Ll=Be({__name:"BeadDetailPage",setup(Z){const K=gt(),F=m("overview"),r=m(null),D=m(!1),P=m(!1),T=m([]),R=m([]),L=m(""),y=ce({visible:!1,type:"",payload:"",message:""}),C=ce({name:"",sourceUrl:"",patternImage:"",workImage:""});function se(d){return new Promise((s,f)=>{const k=new FileReader;k.onload=()=>s(String(k.result||"")),k.onerror=f,k.readAsDataURL(d)})}function _(d){C.name=d.name||"",C.sourceUrl=d.sourceUrl||"",C.patternImage=d.patternImage||"",C.workImage=d.workImage||"",R.value=[...d.tags||[]]}async function le(){const d=Number(K.params.id),[s,f]=await Promise.all([Y.detail(d),Y.tags()]);r.value=s,T.value=f,_(s)}async function M(d){var f;const s=(f=d.target.files)==null?void 0:f[0];s&&(C.patternImage=await se(s))}async function j(d){var f;const s=(f=d.target.files)==null?void 0:f[0];s&&(C.workImage=await se(s))}function U(){C.patternImage=""}function ie(){C.patternImage&&(y.visible=!0,y.type="clear-pattern",y.payload="",y.message="确认删除拼豆图纸吗？删除后仅清空图纸字段，其他内容不变。")}function ne(){C.workImage=""}function re(){const d=L.value.trim();d&&(T.value.includes(d)||T.value.push(d),R.value.includes(d)||R.value.push(d),L.value="")}function G(){r.value&&(_(r.value),P.value=!0)}function I(){r.value&&(_(r.value),P.value=!1)}async function N(d){const s=d.trim();s&&(y.visible=!0,y.type="remove-tag",y.payload=s,y.message=`确认删除 tag「${s}」吗？删除后，所有含该 tag 的拼豆都会移除这个 tag（其他内容不变）。`)}function n(){y.visible=!1,y.type="",y.payload="",y.message=""}async function J(){if(y.type==="clear-pattern"){U(),n();return}if(y.type!=="remove-tag"){n();return}const d=y.payload.trim();if(!d){n();return}try{await Y.deleteTag(d),T.value=T.value.filter(s=>s!==d),R.value=R.value.filter(s=>s!==d),r.value&&(r.value={...r.value,tags:(r.value.tags||[]).filter(s=>s!==d)}),alert(`已删除 tag：${d}`)}catch(s){console.error(s),alert("删除 tag 失败，请稍后重试")}finally{n()}}async function oe(){if(r.value){if(!C.name.trim()){alert("拼豆名称不能为空");return}D.value=!0;try{const d=await Y.update(r.value.id,{name:C.name,tags:R.value,sourceUrl:C.sourceUrl,patternImage:C.patternImage,workImage:C.workImage});r.value=d,_(d),P.value=!1,alert("详情已保存")}catch(d){console.error(d),alert("保存失败，请稍后重试")}finally{D.value=!1}}}return De(async()=>{try{await le()}catch(d){console.error(d),alert("加载详情失败，请稍后重试")}}),(d,s)=>(c(),v(X,null,[r.value?(c(),v("section",Kt,[t("div",Jt,[t("h2",Qt,[s[8]||(s[8]=O(" 拼豆详情： ",-1)),r.value.sourceUrl?(c(),v("a",{key:0,class:"title-link",href:r.value.sourceUrl,target:"_blank",rel:"noopener noreferrer"},h(r.value.name),9,el)):(c(),v("span",tl,h(r.value.name),1))])]),t("div",ll,[t("div",nl,[t("button",{class:ae(["page-tab",{active:F.value==="overview"}]),onClick:s[0]||(s[0]=f=>F.value="overview")},"概况",2),t("button",{class:ae(["page-tab",{active:F.value==="work"}]),onClick:s[1]||(s[1]=f=>F.value="work")},"开始拼豆",2)]),t("button",{class:"btn secondary edit-icon-btn",onClick:G,title:"编辑概况"},"✎")]),F.value==="overview"?(c(),v("div",ol,[t("div",al,[t("div",sl,[s[9]||(s[9]=t("span",{class:"field-label"},"拼豆名称",-1)),s[10]||(s[10]=t("span",{class:"field-label"},"拼豆 tag",-1)),t("span",il,h(r.value.name||"未填写"),1),t("div",rl,[(c(!0),v(X,null,te(r.value.tags,f=>(c(),v("span",{key:f,class:"badge"},h(f),1))),128)),!r.value.tags||r.value.tags.length===0?(c(),v("span",ul,"无")):W("",!0)])])]),t("div",cl,[s[11]||(s[11]=t("div",{class:"field-label"},"拼豆图纸",-1)),r.value.patternImage?(c(),v("img",{key:0,src:r.value.patternImage,class:"detail-image"},null,8,dl)):(c(),v("span",vl,"暂无"))]),t("div",pl,[s[12]||(s[12]=t("div",{class:"field-label"},"我的作品",-1)),r.value.workImage?(c(),v("img",{key:0,src:r.value.workImage,class:"detail-image"},null,8,ml)):(c(),v("span",fl,"暂无"))])])):(c(),ft(Zt,{key:1,project:r.value},null,8,["project"]))])):(c(),v("section",gl,"加载中...")),P.value?(c(),v("div",{key:2,class:"modal-mask",onClick:ue(I,["self"])},[t("div",{class:"modal-panel edit-modal-panel",onClick:s[6]||(s[6]=ue(()=>{},["stop"]))},[s[18]||(s[18]=t("h3",{class:"edit-modal-title"},"编辑概况",-1)),t("div",Cl,[t("label",hl,[s[13]||(s[13]=O("拼豆名称 ",-1)),H(t("input",{class:"input edit-input modal-input","onUpdate:modelValue":s[2]||(s[2]=f=>C.name=f)},null,512),[[V,C.name]])]),s[17]||(s[17]=t("label",{class:"edit-label top-gap"},"拼豆 tag（可复用）",-1)),t("div",null,[t("div",yl,[(c(!0),v(X,null,te(T.value,f=>(c(),v("div",{key:f,class:"tag-item"},[t("label",bl,[H(t("input",{type:"checkbox",value:f,"onUpdate:modelValue":s[3]||(s[3]=k=>R.value=k)},null,8,Fl),[[Ct,R.value]]),O(" "+h(f),1)]),t("button",{class:"tag-remove-btn",onClick:k=>N(f)},"x",8,wl)]))),128))]),t("div",xl,[H(t("input",{class:"input fill-input modal-input","onUpdate:modelValue":s[4]||(s[4]=f=>L.value=f),placeholder:"新增 tag"},null,512),[[V,L.value]]),t("button",{class:"btn secondary subtle-action-btn",onClick:re},"添加")])]),t("label",El,[s[14]||(s[14]=O("图纸来源链接 ",-1)),H(t("input",{class:"input edit-input modal-input","onUpdate:modelValue":s[5]||(s[5]=f=>C.sourceUrl=f),placeholder:"https://..."},null,512),[[V,C.sourceUrl]])]),t("div",Bl,[s[15]||(s[15]=t("label",{class:"edit-label top-gap"},"拼豆图纸",-1)),t("div",Dl,[t("input",{class:"input fill-input modal-input",type:"file",accept:"image/*",onChange:M},null,32),t("button",{class:"btn secondary subtle-action-btn",onClick:ie},"清空拼豆图纸")]),C.patternImage?(c(),v("img",{key:0,src:C.patternImage,class:"detail-image"},null,8,Al)):(c(),v("span",kl,"暂无"))]),t("div",Ml,[s[16]||(s[16]=t("label",{class:"edit-label top-gap"},"我的作品",-1)),t("div",$l,[t("input",{class:"input fill-input modal-input",type:"file",accept:"image/*",onChange:j},null,32),t("button",{class:"btn secondary subtle-action-btn",onClick:ne},"清空我的作品")]),C.workImage?(c(),v("img",{key:0,src:C.workImage,class:"detail-image"},null,8,Rl)):(c(),v("span",_l,"暂无"))])]),t("div",Il,[t("button",{class:"btn secondary",onClick:I,disabled:D.value},"取消",8,Sl),t("button",{class:"btn success",onClick:oe,disabled:D.value},h(D.value?"保存中...":"保存详情"),9,Hl)])])])):W("",!0),y.visible?(c(),v("div",{key:3,class:"modal-mask",onClick:ue(n,["self"])},[t("div",{class:"modal-panel confirm-panel",onClick:s[7]||(s[7]=ue(()=>{},["stop"]))},[s[19]||(s[19]=t("h3",{class:"confirm-title"},"确认操作",-1)),t("p",Tl,h(y.message),1),t("div",{class:"row confirm-actions"},[t("button",{class:"btn secondary",onClick:n},"取消"),t("button",{class:"btn warn",onClick:J},"确认")])])])):W("",!0)],64))}}),jl=Ae(Ll,[["__scopeId","data-v-b0b791a3"]]);export{jl as default};
