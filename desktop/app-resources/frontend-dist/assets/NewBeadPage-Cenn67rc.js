import{d as qt,o as Xt,c as h,a as n,l as T,w,m as q,F as at,r as ut,t as Y,v as ct,n as X,e as I,p as Yt,j as Dt,k as Pt,b as dt,f as y,q as Q,s as Wt,g as $,h as Nt,u as Et,i as g,x as _t,_ as Ot}from"./index-BdZg5HdZ.js";import{b as Z}from"./beads-B4Vxsoum.js";const zt={class:"card new-page"},Ft={class:"row new-layout"},jt={class:"new-col"},At={class:"card tag-card"},Gt={class:"row tag-list"},Qt={class:"tag-item-label"},Zt=["value"],Jt=["onClick"],Kt={class:"row"},te={class:"selected-tags"},ee={class:"new-col"},ne={key:0,class:"card crop-card"},oe=["src"],ae={class:"row selection-row"},le={class:"helper-text"},se={class:"nudge-panel"},ie={class:"row nudge-toolbar"},re={class:"nudge-grid"},ue=["disabled"],ce={class:"table-wrap color-table-wrap"},de={class:"table"},me=["onUpdate:modelValue"],fe=["onUpdate:modelValue"],pe=["onClick"],he={class:"row page-actions"},ge={class:"confirm-text"},d=8,ve=qt({__name:"NewBeadPage",setup(xe){const mt=Et(),L=y([]),k=y([]),D=y(""),b=Q({visible:!1,tag:"",message:""}),P=y(!1),B=y(null),M=y(null),J=y(null),C=y(null),R=y("BR"),H=y(1),e=Q({x:0,y:0,w:0,h:0}),W=y(!1),N=Q({x:0,y:0}),c=Q({name:"",tags:[],status:"TODO",sourceUrl:"",patternImage:"",workImage:"",requiredColors:[]});function lt(o){return new Promise((t,l)=>{const a=new FileReader;a.onload=()=>t(String(a.result||"")),a.onerror=l,a.readAsDataURL(o)})}function E(){const o=U();if(!o)return;const t=o.width*.1,l=o.height*.1;e.x=o.left+t,e.y=o.top+l,e.w=Math.max(d,o.width-t*2),e.h=Math.max(d,o.height-l*2),C.value=null}function _(o,t){t.preventDefault(),t.stopPropagation(),C.value=o,R.value=o,W.value=!0;const l=it(t);l&&(tt(l),K(l))}function ft(o){if(!C.value)return;const t=it(o),l=U();if(!t||!l)return;tt(t),K(t);const a=e.x+e.w,s=e.y+e.h;if(C.value==="TL"){const m=Math.min(Math.max(t.x,l.left),a-d),f=Math.min(Math.max(t.y,l.top),s-d);e.w=a-m,e.h=s-f,e.x=m,e.y=f;return}if(C.value==="TR"){const m=l.left+l.width,f=Math.max(Math.min(t.x,m),e.x+d),r=Math.min(Math.max(t.y,l.top),s-d);e.w=f-e.x,e.h=s-r,e.y=r;return}if(C.value==="BL"){const m=l.top+l.height,f=Math.min(Math.max(t.x,l.left),a-d),r=Math.max(Math.min(t.y,m),e.y+d);e.w=a-f,e.h=r-e.y,e.x=f;return}const i=l.left+l.width,u=l.top+l.height,v=Math.max(Math.min(t.x,i),e.x+d),p=Math.max(Math.min(t.y,u),e.y+d);e.w=v-e.x,e.h=p-e.y}function st(){C.value=null,W.value=!1,(e.w<d||e.h<d)&&E()}function O(){const o=R.value==="TL"?{x:e.x,y:e.y}:R.value==="TR"?{x:e.x+e.w,y:e.y}:R.value==="BL"?{x:e.x,y:e.y+e.h}:{x:e.x+e.w,y:e.y+e.h};W.value=!0,tt(o),K(o)}function z(o,t){const l=U();if(!l)return;const a=Number.isFinite(o)?o:0,s=Number.isFinite(t)?t:0;if(!a&&!s)return;const i=e.x+e.w,u=e.y+e.h,v=l.left+l.width,p=l.top+l.height;if(R.value==="TL"){const r=Math.min(Math.max(e.x+a,l.left),i-d),x=Math.min(Math.max(e.y+s,l.top),u-d);e.w=i-r,e.h=u-x,e.x=r,e.y=x,O();return}if(R.value==="TR"){const r=Math.max(Math.min(i+a,v),e.x+d),x=Math.min(Math.max(e.y+s,l.top),u-d);e.w=r-e.x,e.h=u-x,e.y=x,O();return}if(R.value==="BL"){const r=Math.min(Math.max(e.x+a,l.left),i-d),x=Math.max(Math.min(u+s,p),e.y+d);e.w=i-r,e.h=x-e.y,e.x=r,O();return}const m=Math.max(Math.min(i+a,v),e.x+d),f=Math.max(Math.min(u+s,p),e.y+d);e.w=m-e.x,e.h=f-e.y,O()}function K(o){if(!B.value)return;const t=150,l=12,a=B.value.clientWidth,s=B.value.clientHeight;let i=o.x+l,u=o.y+l;(C.value==="BR"||C.value==="BL")&&(u=o.y-t-l),i+t>a&&(i=a-t),u+t>s&&(u=s-t),i<0&&(i=0),u<0&&(u=0),N.x=i,N.y=u}function tt(o){if(!M.value||!J.value)return;const t=U();if(!t)return;const l=M.value,s=J.value.getContext("2d");if(!s)return;const i=l.naturalWidth/t.width,u=l.naturalHeight/t.height,v=o.x-t.left,p=o.y-t.top,m=v*i,f=p*u,r=150,V=r/4,et=m-V/2,j=f-V/2;s.clearRect(0,0,r,r),s.fillStyle="#fff",s.fillRect(0,0,r,r),s.drawImage(l,et,j,V,V,0,0,r,r),s.strokeStyle="rgba(255, 0, 0, 0.85)",s.lineWidth=1,s.beginPath(),s.moveTo(r/2,0),s.lineTo(r/2,r),s.moveTo(0,r/2),s.lineTo(r,r/2),s.stroke()}function U(){if(!B.value||!M.value)return null;const o=B.value.getBoundingClientRect(),t=M.value.getBoundingClientRect(),l=M.value.naturalWidth,a=M.value.naturalHeight;if(!l||!a)return{left:t.left-o.left,top:t.top-o.top,width:t.width,height:t.height};const s=t.width,i=t.height,u=l/a,v=s/i;let p=s,m=i,f=0,r=0;return u>v?(p=s,m=s/u,r=(i-m)/2):(m=i,p=i*u,f=(s-p)/2),{left:t.left-o.left+f,top:t.top-o.top+r,width:p,height:m}}function it(o){const t=U();if(!B.value||!t)return null;const l=B.value.getBoundingClientRect(),a=t.left+t.width,s=t.top+t.height,i=Math.max(t.left,Math.min(o.clientX-l.left,a)),u=Math.max(t.top,Math.min(o.clientY-l.top,s));return{x:i,y:u}}function pt(){E()}function ht(){E()}async function gt(o){var l;const t=(l=o.target.files)==null?void 0:l[0];t&&(c.patternImage=await lt(t),await Wt(),E())}async function vt(o){var l;const t=(l=o.target.files)==null?void 0:l[0];t&&(c.workImage=await lt(t))}async function xt(){if(c.patternImage){if(!S.value){alert("请先在图纸上框选色号说明区域");return}P.value=!0;try{const o=kt(),t=await Z.extractColors(o);c.requiredColors=t,t.length===0&&alert("未识别到有效色号，请调整图纸清晰度后重试，或手动添加。")}catch(o){console.error(o),alert("图纸识别失败，请重试或手动添加色号。")}finally{P.value=!1}}}function yt(o){var t;(t=c.requiredColors)==null||t.splice(o,1)}function wt(){c.requiredColors||(c.requiredColors=[]),c.requiredColors.push({code:"",quantity:1})}async function bt(){var t;if(c.tags=k.value,!((t=c.name)!=null&&t.trim()))return alert("拼豆名称必填");if(!c.status)return alert("拼豆状态必填");if(!c.patternImage)return alert("拼豆图纸必填");if(!c.requiredColors||c.requiredColors.length===0)return alert("提取色号与数量必填");const o=await Z.create({...c,quantityDone:0,quantityPlan:1});mt.push(`/detail/${o.id}`)}function Mt(){const o=D.value.trim();o&&(L.value.includes(o)||L.value.push(o),k.value.includes(o)||k.value.push(o),D.value="")}async function Ct(o){const t=o.trim();t&&(b.visible=!0,b.tag=t,b.message=`确认删除 tag「${t}」吗？删除后，所有含该 tag 的拼豆都会移除这个 tag（其他内容不变）。`)}function F(){b.visible=!1,b.tag="",b.message=""}async function Rt(){const o=b.tag.trim();if(!o){F();return}try{await Z.deleteTag(o),L.value=L.value.filter(t=>t!==o),k.value=k.value.filter(t=>t!==o),alert(`已删除 tag：${o}`)}catch(t){console.error(t),alert("删除 tag 失败，请稍后重试")}finally{F()}}function kt(){if(!M.value||!S.value)throw new Error("未选择裁剪区域");const o=U();if(!o)throw new Error("图像位置无效");const t=M.value,l=o.width,a=o.height;if(!l||!a)throw new Error("图像尺寸无效");const s=t.naturalWidth/l,i=t.naturalHeight/a,u=8,v=u*s,p=u*i,m=e.x-o.left,f=e.y-o.top,r=m*s,x=f*i,V=e.w*s,et=e.h*i,j=Math.max(0,Math.floor(r-v)),rt=Math.max(0,Math.floor(x-p)),Ut=Math.min(t.naturalWidth,Math.ceil(r+V+v)),Vt=Math.min(t.naturalHeight,Math.ceil(x+et+p)),nt=Math.max(1,Ut-j),ot=Math.max(1,Vt-rt),A=document.createElement("canvas");A.width=nt,A.height=ot;const G=A.getContext("2d");if(!G)throw new Error("无法创建图像上下文");return G.imageSmoothingEnabled=!0,G.imageSmoothingQuality="high",G.drawImage(t,j,rt,nt,ot,0,0,nt,ot),A.toDataURL("image/jpeg",.95)}const S=$(()=>e.w>0&&e.h>0),Bt=$(()=>({left:`${e.x}px`,top:`${e.y}px`,width:`${e.w}px`,height:`${e.h}px`})),St=$(()=>({left:`${e.x}px`,top:`${e.y}px`})),$t=$(()=>({left:`${e.x+e.w}px`,top:`${e.y}px`})),Tt=$(()=>({left:`${e.x}px`,top:`${e.y+e.h}px`})),It=$(()=>({left:`${e.x+e.w}px`,top:`${e.y+e.h}px`})),Lt=$(()=>{if(!S.value)return"未框选";const o=Math.round(e.x),t=Math.round(e.y),l=Math.round(e.x+e.w),a=Math.round(e.y+e.h);return`左上(${o}, ${t}) 右下(${l}, ${a})`}),Ht=$(()=>({left:`${N.x}px`,top:`${N.y}px`}));return Xt(async()=>{try{L.value=await Z.tags()}catch(o){console.error(o)}}),(o,t)=>{const l=Nt("RouterLink");return g(),h(at,null,[n("section",zt,[t[30]||(t[30]=n("h2",{class:"section-title"},"新建拼豆",-1)),n("div",Ft,[n("div",jt,[n("label",null,[t[16]||(t[16]=T("拼豆名称（必填）",-1)),w(n("input",{class:"input","onUpdate:modelValue":t[0]||(t[0]=a=>c.name=a)},null,512),[[q,c.name]])]),t[22]||(t[22]=n("label",null,"拼豆 tag（可复用）",-1)),n("div",At,[n("div",Gt,[(g(!0),h(at,null,ut(L.value,a=>(g(),h("div",{key:a,class:"tag-item"},[n("label",Qt,[w(n("input",{type:"checkbox",value:a,"onUpdate:modelValue":t[1]||(t[1]=s=>k.value=s)},null,8,Zt),[[_t,k.value]]),T(" "+Y(a),1)]),n("button",{class:"tag-remove-btn",onClick:s=>Ct(a)},"x",8,Jt)]))),128))]),n("div",Kt,[w(n("input",{class:"input","onUpdate:modelValue":t[2]||(t[2]=a=>D.value=a),placeholder:"新增 tag"},null,512),[[q,D.value]]),n("button",{class:"btn secondary",onClick:Mt},"添加")]),n("div",te,"已选："+Y(k.value.join(", ")||"无"),1)]),n("label",null,[t[18]||(t[18]=T("拼豆状态（必填） ",-1)),w(n("select",{class:"select","onUpdate:modelValue":t[3]||(t[3]=a=>c.status=a)},[...t[17]||(t[17]=[n("option",{value:"DONE"},"已拼完",-1),n("option",{value:"IN_PROGRESS"},"正在拼",-1),n("option",{value:"TODO"},"将要拼",-1)])],512),[[ct,c.status]])]),n("label",null,[t[19]||(t[19]=T("图纸来源链接",-1)),w(n("input",{class:"input","onUpdate:modelValue":t[4]||(t[4]=a=>c.sourceUrl=a),placeholder:"https://..."},null,512),[[q,c.sourceUrl]])]),n("label",null,[t[20]||(t[20]=T("拼豆图纸（必填）",-1)),n("input",{class:"input",type:"file",accept:"image/*",onChange:gt},null,32)]),n("label",null,[t[21]||(t[21]=T("我的作品",-1)),n("input",{class:"input",type:"file",accept:"image/*",onChange:vt},null,32)])]),n("div",ee,[t[28]||(t[28]=n("h3",{class:"extract-title"},"提取色号与数量（必填）",-1)),c.patternImage?(g(),h("div",ne,[t[26]||(t[26]=n("div",{class:"helper-text"},"可拖动四个角控制点定位“色号+数量”区域，再点击提取",-1)),n("div",{ref_key:"cropStageRef",ref:B,class:"crop-stage",onMousemove:ft,onMouseup:st,onMouseleave:st},[n("img",{ref_key:"patternImgRef",ref:M,src:c.patternImage,class:"crop-image",onLoad:pt},null,40,oe),S.value?(g(),h("div",{key:0,class:"crop-mask",style:X(Bt.value)},null,4)):I("",!0),S.value?(g(),h("div",{key:1,class:"crop-handle tl",style:X(St.value),onMousedown:t[5]||(t[5]=a=>_("TL",a))},null,36)):I("",!0),S.value?(g(),h("div",{key:2,class:"crop-handle tr",style:X($t.value),onMousedown:t[6]||(t[6]=a=>_("TR",a))},null,36)):I("",!0),S.value?(g(),h("div",{key:3,class:"crop-handle bl",style:X(Tt.value),onMousedown:t[7]||(t[7]=a=>_("BL",a))},null,36)):I("",!0),S.value?(g(),h("div",{key:4,class:"crop-handle br",style:X(It.value),onMousedown:t[8]||(t[8]=a=>_("BR",a))},null,36)):I("",!0),w(n("div",{class:"magnifier",style:X(Ht.value)},[n("canvas",{ref_key:"magnifierCanvasRef",ref:J,width:"150",height:"150"},null,512)],4),[[Yt,W.value]])],544),n("div",ae,[n("div",le,Y(Lt.value),1),n("button",{class:"btn secondary",onClick:ht},"重置选区")]),n("div",se,[n("div",ie,[t[24]||(t[24]=n("label",{class:"helper-text"},"微调角点",-1)),w(n("select",{class:"select nudge-select","onUpdate:modelValue":t[9]||(t[9]=a=>R.value=a)},[...t[23]||(t[23]=[n("option",{value:"TL"},"左上角",-1),n("option",{value:"TR"},"右上角",-1),n("option",{value:"BL"},"左下角",-1),n("option",{value:"BR"},"右下角",-1)])],512),[[ct,R.value]]),t[25]||(t[25]=n("label",{class:"helper-text"},"步长",-1)),w(n("input",{class:"input nudge-input",type:"number",min:"1",max:"20","onUpdate:modelValue":t[10]||(t[10]=a=>H.value=a)},null,512),[[q,H.value,void 0,{number:!0}]])]),n("div",re,[n("button",{class:"btn secondary",onClick:t[11]||(t[11]=a=>z(0,-H.value))},"↑"),n("button",{class:"btn secondary",onClick:t[12]||(t[12]=a=>z(-H.value,0))},"←"),n("button",{class:"btn secondary",onClick:t[13]||(t[13]=a=>z(H.value,0))},"→"),n("button",{class:"btn secondary",onClick:t[14]||(t[14]=a=>z(0,H.value))},"↓")])])])):I("",!0),n("button",{class:"btn secondary",onClick:xt,disabled:!c.patternImage||P.value},Y(P.value?"识别中...":"从图纸提取色号"),9,ue),n("div",ce,[n("table",de,[t[27]||(t[27]=n("thead",null,[n("tr",null,[n("th",null,"色号"),n("th",null,"数量"),n("th")])],-1)),n("tbody",null,[(g(!0),h(at,null,ut(c.requiredColors,(a,s)=>(g(),h("tr",{key:s},[n("td",null,[w(n("input",{class:"input","onUpdate:modelValue":i=>a.code=i},null,8,me),[[q,a.code]])]),n("td",null,[w(n("input",{class:"input",type:"number",min:"1","onUpdate:modelValue":i=>a.quantity=i},null,8,fe),[[q,a.quantity,void 0,{number:!0}]])]),n("td",null,[n("button",{class:"btn warn",onClick:i=>yt(s)},"删",8,pe)])]))),128))])])]),n("button",{class:"btn secondary",onClick:wt},"+ 手动添加色号")])]),n("div",he,[n("button",{class:"btn success",onClick:bt},"保存"),Dt(l,{class:"btn secondary",to:"/overview"},{default:Pt(()=>[...t[29]||(t[29]=[T("返回总览",-1)])]),_:1})])]),b.visible?(g(),h("div",{key:0,class:"modal-mask",onClick:dt(F,["self"])},[n("div",{class:"modal-panel confirm-panel",onClick:t[15]||(t[15]=dt(()=>{},["stop"]))},[t[31]||(t[31]=n("h3",{class:"confirm-title"},"确认操作",-1)),n("p",ge,Y(b.message),1),n("div",{class:"row confirm-actions"},[n("button",{class:"btn secondary",onClick:F},"取消"),n("button",{class:"btn warn",onClick:Rt},"确认")])])])):I("",!0)],64)}}}),be=Ot(ve,[["__scopeId","data-v-1edd9579"]]);export{be as default};
