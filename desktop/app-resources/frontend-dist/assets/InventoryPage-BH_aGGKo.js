import{d as De,z as Be,o as pe,c,a as o,B as S,F as C,r as m,w as b,v as fe,t as u,e as E,m as N,f as r,g as Z,i as a,n as R,E as x,l as f,A as oe,b as le,C as se,k as ne,h as ke,_ as ye}from"./index-BdZg5HdZ.js";import{b as B}from"./beads-B4Vxsoum.js";const Ae={A1:"#FAF5CD",A2:"#FCFED6",A3:"#FCFF92",A4:"#F7EC5C",A5:"#FFE44B",A6:"#FDA951",A7:"#FA8C4F",A8:"#F9E045",A9:"#F99C5F",A10:"#F47E36",A11:"#FEDB99",A12:"#FDA276",A13:"#FEC667",A14:"#F85842",A15:"#FBF65E",A16:"#FEFF97",A17:"#FDE173",A18:"#FCBF80",A19:"#FD7E77",A20:"#F9D66E",A21:"#FAE393",A22:"#EDF878",A23:"#E1C9BD",A24:"#F3F6A9",A25:"#FFD785",A26:"#FEC832",B1:"#DFF139",B2:"#64F343",B3:"#9FF685",B4:"#5FDF34",B5:"#39E158",B6:"#64B0A4",B7:"#3FAE7C",B8:"#1D9E54",B9:"#2A5037",B10:"#9AD1BA",B11:"#627032",B12:"#1A6E3D",B13:"#C8E87D",B14:"#ACE84C",B15:"#305335",B16:"#C0ED9C",B17:"#9FB33E",B18:"#E6ED4F",B19:"#26B78E",B20:"#CAEDCF",B21:"#176268",B22:"#0A4241",B23:"#343B1A",B24:"#E8FAA6",B25:"#4E846D",B26:"#907C35",B27:"#D0E0AF",B28:"#9EE5BB",B29:"#C6DF5F",B30:"#E3FBB1",B31:"#B2F694",B32:"#92AD60",C1:"#FFFEE4",C2:"#ABF8FE",C3:"#9EE0F8",C4:"#44CDFB",C5:"#06ABE3",C6:"#54A7E9",C7:"#3977CC",C8:"#0F52BD",C9:"#3349C3",C10:"#3DBBE3",C11:"#2ADED3",C12:"#1E334E",C13:"#CDE7FE",C14:"#D6FDFC",C15:"#21C5C4",C16:"#1858A2",C17:"#02D1F3",C18:"#213244",C19:"#188690",C20:"#1A70A9",C21:"#BEDDFC",C22:"#6BB1BB",C23:"#C8E2F9",C24:"#7EC5F9",C25:"#A9E8E0",C26:"#42ADD1",C27:"#D0DEEF",C28:"#BDCEED",C29:"#364A89",D1:"#ACB7EF",D2:"#868DD3",D3:"#3653AF",D4:"#162C7E",D5:"#B34EC6",D6:"#B37BDC",D7:"#8758A9",D8:"#E3D2FE",D9:"#D6BAF5",D10:"#301A49",D11:"#BCBAE2",D12:"#DC99CE",D13:"#B5038F",D14:"#882893",D15:"#2F1E8E",D16:"#E2E4F0",D17:"#C7D3F9",D18:"#9A64B8",D19:"#D8C2D9",D20:"#9C34AD",D21:"#940595",D22:"#383995",D23:"#FADBF8",D24:"#768AE1",D25:"#4950C2",D26:"#D6C6EB",E1:"#F6D4CB",E2:"#FCC1DD",E3:"#F6BDE8",E4:"#E9639E",E5:"#F1559F",E6:"#BC4072",E7:"#C63674",E8:"#FDDBE9",E9:"#E575C7",E10:"#D33997",E11:"#F7DAD4",E12:"#F893BF",E13:"#B5026A",E14:"#FAD4BF",E15:"#F5C9CA",E16:"#FBF4EC",E17:"#F7E3EC",E18:"#FBCBDB",E19:"#F6BBD1",E20:"#D7C6CE",E21:"#C09DA4",E22:"#B58B9F",E23:"#937D8A",E24:"#DEBEE5",F1:"#FF9280",F2:"#F73D48",F3:"#EF4D3E",F4:"#F92B40",F5:"#E30328",F6:"#913635",F7:"#911932",F8:"#BB0126",F9:"#B0677A",F10:"#874628",F11:"#6F321D",F12:"#F8516D",F13:"#F45C45",F14:"#FCADB2",F15:"#D50527",F16:"#F8C0A9",F17:"#E89B7D",F18:"#D07E4A",F19:"#BE454A",F20:"#C69495",F21:"#F2BBC6",F22:"#F7C3D0",F23:"#EC806D",F24:"#E09DAF",F25:"#E84854",G1:"#FFEAD3",G2:"#FCC6AC",G3:"#F1C4A5",G4:"#DCB387",G5:"#E7B34E",G6:"#F3A014",G7:"#98503A",G8:"#4B2B1C",G9:"#E4B685",G10:"#DA8C42",G11:"#DAC898",G12:"#FEC993",G13:"#B2714B",G14:"#8B684C",G15:"#F6F8E3",G16:"#F2D8C1",G17:"#79544E",G18:"#FFEAD6",G19:"#DD7D41",G20:"#A5452F",G21:"#B38561",H1:"#FBFBFB",H2:"#FFFFFF",H3:"#B4B4B4",H4:"#878787",H5:"#464648",H6:"#2C2C2C",H7:"#010101",H8:"#E7D6DC",H9:"#EFEDEE",H10:"#ECEAEB",H11:"#CDCDCD",H12:"#FDF6EE",H13:"#F4EFD1",H14:"#CED7D4",H15:"#98A6A6",H16:"#1B1213",H17:"#F0EEEF",H18:"#FCFFF8",H19:"#F2EEE5",H20:"#96A09F",H21:"#F8FBE6",H22:"#CACADA",H23:"#9B9C94",M1:"#BBC6B6",M2:"#909994",M3:"#697E30",M4:"#E0D4BC",M5:"#D0CBAE",M6:"#B0AA86",M7:"#B0A796",M8:"#AE8082",M9:"#A88764",M10:"#C6B2BB",M11:"#9D7693",M12:"#644B51",M13:"#C79266",M14:"#C37463",M15:"#747D7A"};function F(g){return String(g||"").toUpperCase().trim().replace(/^([A-Z]+)0+(?=\d)/,"$1")}function z(g){const i=F(g);return Ae[i]||""}const he={class:"card inventory-page"},be={class:"tabs"},ge={class:"quick-jump"},_e=["onClick"],je={key:0,class:"row stock-toolbar"},Me={class:"table"},Te=["data-code"],$e={class:"code-cell"},we={class:"narrow-col"},Ie={class:"saving-cell"},He=["onUpdate:modelValue","onInput","onBlur","onKeydown"],Ge={key:0,class:"saving-text"},Se={class:"narrow-col"},Ne={class:"saving-cell"},Re=["onUpdate:modelValue","onInput","onBlur","onKeydown"],xe={key:0,class:"saving-text"},ze={class:"table sticky-usage"},Ue=["href"],Ve=["src"],We={key:0},Pe=["colspan"],qe=["data-code"],Ke={class:"sticky-col usage-col-1 usage-body-sticky"},Le={class:"code-cell"},Oe={class:"sticky-col usage-col-2 usage-body-sticky"},Xe={class:"table sticky-demand"},Ye=["href"],Ze=["src"],Je={key:0},Qe=["colspan"],et=["data-code"],tt={class:"sticky-col demand-col-1 demand-body-sticky"},ot={class:"code-cell"},lt={class:"sticky-col demand-col-2 demand-body-sticky"},st={class:"sticky-col demand-col-3 demand-body-sticky"},nt={class:"sticky-col demand-col-4 demand-body-sticky"},at={key:0,class:"modal-mask"},ct={class:"modal-panel"},dt={class:"row-between dialog-toolbar"},ut={class:"row dialog-actions"},rt={class:"table-wrap",style:{"max-height":"50vh"}},it={class:"table"},Ft={class:"code-cell"},vt={class:"restock-col"},Ct=["onUpdate:modelValue"],mt=De({__name:"InventoryPage",setup(g){const i=r("stock"),ae=["A","B","C","D","E","F","G","H","M"],v=r([]),_=r([]),j=r([]),ce=r([]),U=r("code"),M=r(!1),T=r({}),k=r({}),$=r({}),y=r({}),w=r(!1),p=r({}),V=r(1e3),A=new Map,h=new Map,W=r(null),P=r(null),q=r(null),I=Z(()=>Q(_.value.flatMap(l=>l.projects))),H=Z(()=>Q(j.value.flatMap(l=>l.projects))),J=Z(()=>{const l=[...v.value];return l.sort((e,s)=>U.value==="code"?de(e.code,s.code):String(e.warning).localeCompare(String(s.warning),"zh-CN")),M.value&&l.reverse(),l});function D(l){return F(l)}function de(l,e){const s=F(l||""),t=F(e||""),n=/^([A-Z]+)(\d+)$/,d=s.match(n),Y=t.match(n);if(d&&Y){const te=d[1].localeCompare(Y[1],"zh-CN");return te!==0?te:Number(d[2])-Number(Y[2])}return s.localeCompare(t,"zh-CN")}function K(l){const e={},s={},t={};for(const n of l){const d=F(n.code);e[d]=n.alertThreshold??0,s[d]=n.inTotal??0,t[d]=p.value[d]??0}T.value=e,$.value=s,p.value=t}async function G(){const[l,e,s,t]=await Promise.allSettled([B.inventory.stock(),B.inventory.usage(),B.inventory.demand(),B.inventory.todoProjects()]);v.value=l.status==="fulfilled"?l.value.map(n=>({...n,code:F(n.code)})):[],_.value=e.status==="fulfilled"?e.value.map(n=>({...n,code:F(n.code)})):[],j.value=s.status==="fulfilled"?s.value.map(n=>({...n,code:F(n.code)})):[],ce.value=t.status==="fulfilled"?t.value:[],K(v.value),(l.status==="rejected"||e.status==="rejected"||s.status==="rejected")&&(console.error("库存页关键接口存在失败",{stock:l,usage:e,demand:s}),alert("部分库存接口请求失败，请检查后端是否为最新版本并已重启"))}function Q(l){const e=new Map;for(const s of l)e.has(s.projectId)||e.set(s.projectId,s);return[...e.values()].sort((s,t)=>String(s.projectName||"").localeCompare(String(t.projectName||""),"zh-CN"))}function ee(l,e){const s=l.find(t=>t.projectId===e);return(s==null?void 0:s.used)??0}function ue(l){return l.reduce((e,s)=>e+Number(s.used||0),0)}async function L(l){var n;const e=F(l),s=Math.max(0,Number(T.value[e]??0)),t=((n=v.value.find(d=>d.code===e))==null?void 0:n.alertThreshold)??0;if(s!==t){k.value={...k.value,[e]:!0};try{v.value=await B.inventory.updateThresholds({[e]:s}),v.value=v.value.map(d=>({...d,code:F(d.code)})),K(v.value)}catch(d){console.error(d),alert(`色号 ${e} 阈值保存失败`),await G()}finally{k.value={...k.value,[e]:!1}}}}function re(l){const e=F(l),s=h.get(e);s&&window.clearTimeout(s);const t=window.setTimeout(()=>{h.delete(e),L(e)},450);h.set(e,t)}async function O(l){var n;const e=F(l),s=Math.max(0,Number($.value[e]??0)),t=((n=v.value.find(d=>d.code===e))==null?void 0:n.inTotal)??0;if(s!==t){y.value={...y.value,[e]:!0};try{v.value=await B.inventory.updateInTotals({[e]:s}),v.value=v.value.map(d=>({...d,code:F(d.code)})),K(v.value)}catch(d){console.error(d),alert(`色号 ${e} 入库总量保存失败`),await G()}finally{y.value={...y.value,[e]:!1}}}}function ie(l){const e=F(l),s=A.get(e);s&&window.clearTimeout(s);const t=window.setTimeout(()=>{A.delete(e),O(e)},450);A.set(e,t)}function Fe(){w.value=!0}function ve(l){const e={},s=Math.max(0,Number(l||0));for(const t of v.value)e[t.code]=s;p.value=e}function Ce(l){const e=i.value==="stock"?W.value:i.value==="usage"?P.value:q.value;if(!e)return;const s=e.querySelector(`tr[data-code^="${l}"]`);s&&s.scrollIntoView({behavior:"smooth",block:"center"})}function X(l,e){if(!l.shiftKey)return;const s=e==="stock"?W.value:e==="usage"?P.value:q.value;if(!s||!(s.scrollWidth>s.clientWidth))return;const n=l.deltaY===0?l.deltaX:l.deltaY;n!==0&&(l.preventDefault(),s.scrollLeft+=n)}function me(l){return String(l||"").includes("急需补货")?"warning-low":"warning-ok"}async function Ee(){const l={};for(const[e,s]of Object.entries(p.value)){const t=F(e),n=Math.max(0,Number(s||0));n>0&&(l[t]=(l[t]||0)+n)}if(Object.keys(l).length===0){alert("请先填写至少一个色号的入库数量");return}await B.inventory.restock(l),await G(),w.value=!1,alert("入库完成")}return Be(()=>{for(const l of A.values())window.clearTimeout(l);A.clear();for(const l of h.values())window.clearTimeout(l);h.clear()}),pe(async()=>{try{await G()}catch(l){console.error(l),alert("库存数据加载失败，请确认后端服务已启动")}}),(l,e)=>{const s=ke("RouterLink");return a(),c(C,null,[o("section",he,[e[27]||(e[27]=o("h2",{class:"section-title"},"库存总览",-1)),o("div",be,[o("button",{class:S(["tab",{active:i.value==="stock"}]),onClick:e[0]||(e[0]=t=>i.value="stock")},"库存表",2),o("button",{class:S(["tab",{active:i.value==="usage"}]),onClick:e[1]||(e[1]=t=>i.value="usage")},"使用表",2),o("button",{class:S(["tab",{active:i.value==="demand"}]),onClick:e[2]||(e[2]=t=>i.value="demand")},"需求表",2)]),o("div",ge,[e[11]||(e[11]=o("span",{class:"quick-jump-label"},"快速跳转：",-1)),(a(),c(C,null,m(ae,t=>o("button",{key:t,class:"btn secondary jump-btn",onClick:n=>Ce(t)},u(t),9,_e)),64))]),i.value==="stock"?(a(),c("div",je,[e[13]||(e[13]=o("label",null,"排序字段",-1)),b(o("select",{class:"select stock-select","onUpdate:modelValue":e[3]||(e[3]=t=>U.value=t)},[...e[12]||(e[12]=[o("option",{value:"code"},"色号",-1),o("option",{value:"warning"},"库存预警",-1)])],512),[[fe,U.value]]),o("button",{class:"btn secondary",onClick:e[4]||(e[4]=t=>M.value=!M.value)},u(M.value?"降序":"升序"),1),o("button",{class:"btn",onClick:Fe},"入库")])):E("",!0),i.value==="stock"?(a(),c("div",{key:1,class:"table-wrap",ref_key:"stockTableWrapRef",ref:W,onWheel:e[5]||(e[5]=t=>X(t,"stock"))},[o("table",Me,[e[14]||(e[14]=o("thead",null,[o("tr",null,[o("th",null,"色号"),o("th",null,"入库总量"),o("th",null,"库存余量"),o("th",null,"使用量"),o("th",null,"提醒阈值"),o("th",null,"库存预警")])],-1)),o("tbody",null,[(a(!0),c(C,null,m(J.value,t=>(a(),c("tr",{key:t.code,"data-code":D(t.code)},[o("td",null,[o("span",$e,[o("span",{class:"color-dot",style:R({background:x(z)(t.code)||"#fff"})},null,4),f(" "+u(D(t.code)),1)])]),o("td",we,[o("div",Ie,[b(o("input",{class:"input compact-input",type:"number",min:"0","onUpdate:modelValue":n=>$.value[t.code]=n,onInput:n=>ie(t.code),onBlur:n=>O(t.code),onKeydown:oe(le(n=>O(t.code),["prevent"]),["enter"])},null,40,He),[[N,$.value[t.code],void 0,{number:!0}]]),y.value[t.code]?(a(),c("span",Ge,"保存中...")):E("",!0)])]),o("td",null,u(t.remain),1),o("td",null,u(t.used),1),o("td",Se,[o("div",Ne,[b(o("input",{class:"input compact-input",type:"number",min:"0","onUpdate:modelValue":n=>T.value[t.code]=n,onInput:n=>re(t.code),onBlur:n=>L(t.code),onKeydown:oe(le(n=>L(t.code),["prevent"]),["enter"])},null,40,Re),[[N,T.value[t.code],void 0,{number:!0}]]),k.value[t.code]?(a(),c("span",xe,"保存中...")):E("",!0)])]),o("td",null,[o("span",{class:S(["warning-badge",me(t.warning)])},u(t.warning),3)])],8,Te))),128))])])],544)):E("",!0),i.value==="usage"?(a(),c("div",{key:2,class:"table-wrap",ref_key:"usageTableWrapRef",ref:P,onWheel:e[6]||(e[6]=t=>X(t,"usage"))},[o("table",ze,[o("thead",null,[o("tr",null,[e[15]||(e[15]=o("th",{class:"sticky-col usage-col-1"},"色号",-1)),e[16]||(e[16]=o("th",{class:"sticky-col usage-col-2"},"总使用",-1)),(a(!0),c(C,null,m(I.value,t=>(a(),c("th",{key:`usage-head-${t.projectId}`,class:"usage-head-row1"},[t.projectUrl?(a(),c("a",{key:0,href:t.projectUrl,target:"_blank"},u(t.projectName),9,Ue)):(a(),se(s,{key:1,to:`/detail/${t.projectId}`},{default:ne(()=>[f(u(t.projectName),1)]),_:2},1032,["to"]))]))),128))]),o("tr",null,[e[17]||(e[17]=o("th",{class:"sticky-col usage-col-1 usage-head-row2"},null,-1)),e[18]||(e[18]=o("th",{class:"sticky-col usage-col-2 usage-head-row2"},null,-1)),(a(!0),c(C,null,m(I.value,t=>(a(),c("th",{key:`usage-image-${t.projectId}`,class:"usage-head-row2"},[t.projectImage?(a(),c("img",{key:0,src:t.projectImage,class:"project-thumb"},null,8,Ve)):E("",!0)]))),128))])]),o("tbody",null,[_.value.length===0?(a(),c("tr",We,[o("td",{colspan:2+I.value.length},"暂无使用数据",8,Pe)])):E("",!0),(a(!0),c(C,null,m(_.value,t=>(a(),c("tr",{key:t.code,"data-code":D(t.code)},[o("td",Ke,[o("span",Le,[o("span",{class:"color-dot",style:R({background:x(z)(t.code)||"#fff"})},null,4),f(" "+u(D(t.code)),1)])]),o("td",Oe,u(t.used),1),(a(!0),c(C,null,m(I.value,n=>(a(),c("td",{key:`usage-body-${t.code}-${n.projectId}`},u(ee(t.projects,n.projectId)),1))),128))],8,qe))),128))])])],544)):E("",!0),i.value==="demand"?(a(),c("div",{key:3,class:"table-wrap",ref_key:"demandTableWrapRef",ref:q,onWheel:e[7]||(e[7]=t=>X(t,"demand"))},[o("table",Xe,[o("thead",null,[o("tr",null,[e[19]||(e[19]=o("th",{class:"sticky-col demand-col-1"},"色号",-1)),e[20]||(e[20]=o("th",{class:"sticky-col demand-col-2"},"库存余量",-1)),e[21]||(e[21]=o("th",{class:"sticky-col demand-col-3"},"总需求",-1)),e[22]||(e[22]=o("th",{class:"sticky-col demand-col-4"},"需补库存量",-1)),(a(!0),c(C,null,m(H.value,t=>(a(),c("th",{key:`demand-head-${t.projectId}`,class:"demand-head-row1"},[t.projectUrl?(a(),c("a",{key:0,href:t.projectUrl,target:"_blank"},u(t.projectName),9,Ye)):(a(),se(s,{key:1,to:`/detail/${t.projectId}`},{default:ne(()=>[f(u(t.projectName),1)]),_:2},1032,["to"]))]))),128))]),o("tr",null,[e[23]||(e[23]=o("th",{class:"sticky-col demand-col-1 demand-head-row2"},null,-1)),e[24]||(e[24]=o("th",{class:"sticky-col demand-col-2 demand-head-row2"},null,-1)),e[25]||(e[25]=o("th",{class:"sticky-col demand-col-3 demand-head-row2"},null,-1)),e[26]||(e[26]=o("th",{class:"sticky-col demand-col-4 demand-head-row2"},null,-1)),(a(!0),c(C,null,m(H.value,t=>(a(),c("th",{key:`demand-image-${t.projectId}`,class:"demand-head-row2"},[t.projectImage?(a(),c("img",{key:0,src:t.projectImage,class:"project-thumb"},null,8,Ze)):E("",!0)]))),128))])]),o("tbody",null,[j.value.length===0?(a(),c("tr",Je,[o("td",{colspan:4+H.value.length},"暂无需求数据",8,Qe)])):E("",!0),(a(!0),c(C,null,m(j.value,t=>(a(),c("tr",{key:t.code,"data-code":D(t.code)},[o("td",tt,[o("span",ot,[o("span",{class:"color-dot",style:R({background:x(z)(t.code)||"#fff"})},null,4),f(" "+u(D(t.code)),1)])]),o("td",lt,u(t.remain),1),o("td",st,u(ue(t.projects)),1),o("td",nt,u(t.need),1),(a(!0),c(C,null,m(H.value,n=>(a(),c("td",{key:`demand-body-${t.code}-${n.projectId}`},u(ee(t.projects,n.projectId)),1))),128))],8,et))),128))])])],544)):E("",!0)]),w.value?(a(),c("div",at,[o("div",ct,[o("div",dt,[e[28]||(e[28]=o("h3",{class:"dialog-title"},"批量入库",-1)),o("button",{class:"btn secondary",onClick:e[8]||(e[8]=t=>w.value=!1)},"关闭")]),o("div",ut,[e[29]||(e[29]=o("label",null,"统一填充",-1)),b(o("input",{class:"input uniform-input",type:"number",min:"0","onUpdate:modelValue":e[9]||(e[9]=t=>V.value=t)},null,512),[[N,V.value,void 0,{number:!0}]]),o("button",{class:"btn warn",onClick:e[10]||(e[10]=t=>ve(V.value))},"应用到全部"),o("button",{class:"btn success",onClick:Ee},"确认入库")]),o("div",rt,[o("table",it,[e[30]||(e[30]=o("thead",null,[o("tr",null,[o("th",null,"色号"),o("th",null,"入库数量")])],-1)),o("tbody",null,[(a(!0),c(C,null,m(J.value,t=>(a(),c("tr",{key:`restock-${t.code}`},[o("td",null,[o("span",Ft,[o("span",{class:"color-dot",style:R({background:x(z)(t.code)||"#fff"})},null,4),f(" "+u(D(t.code)),1)])]),o("td",vt,[b(o("input",{class:"input",type:"number",min:"0","onUpdate:modelValue":n=>p.value[t.code]=n},null,8,Ct),[[N,p.value[t.code],void 0,{number:!0}]])])]))),128))])])])])])):E("",!0)],64)}}}),Bt=ye(mt,[["__scopeId","data-v-8a59c707"]]);export{Bt as default};
